# Plonk Code Review

**Date:** 2025-12-09
**Reviewer:** External Code Review
**Last Updated:** 2025-12-11
**Scope:** Full codebase review focusing on functionality, UX, maintainability, and suggested refinements

---

## Executive Summary

Plonk is a well-designed, thoughtfully-architected CLI tool for unified package and dotfile management. The configuration-driven package manager approach is elegant, the codebase follows Go best practices, and there's clear attention to UX. This review identifies areas for refinement to take the tool from good to great.

**Overall Assessment:** Strong foundation with room for polish.

---

## Strengths

| Area                  | Observation                                                                              |
| --------------------- | ---------------------------------------------------------------------------------------- |
| **Architecture**      | Clean separation: commands → orchestrator → resources → config. Easy to reason about.    |
| **Extensibility**     | YAML-driven package managers is brilliant—users can add managers without recompiling.    |
| **Testing**           | 90+ test files with table-driven tests, mocks, golden files, and BATS integration tests. |
| **UX Polish**         | Spinners, color support, `NO_COLOR` respect, multiple output formats (table/json/yaml).  |
| **Idempotency**       | Pattern-based idempotent error handling ensures safe re-runs.                            |
| **Atomic Operations** | Lock file and dotfile writes use atomic file operations—good data safety.                |

---

## Functionality Issues

### ~~1. Selective Apply Not Implemented~~ ✅ RESOLVED

**Status:** Fixed as of 2025-12-11

**Original Issue:** `internal/commands/apply.go:174-177` had a TODO indicating selective apply was not implemented.

**Resolution:** `runSelectiveApply()` function now exists at lines 152-220, properly filtering specific dotfiles when paths are provided as arguments.

---

### 2. IsInstalled Is O(n) Per Check

**File:** `internal/resources/packages/generic.go:145-158`

```go
func (g *GenericManager) IsInstalled(ctx context.Context, name string) (bool, error) {
    installed, err := g.ListInstalled(ctx)  // Calls package manager every time
    // ... linear search
}
```

**Impact:** Checking 10 packages means 10 subprocess invocations. Slow for large package lists.

**Recommendation:** Cache `ListInstalled` results with a short TTL or build a `map[string]bool` once per session.

**Priority:** Medium

---

### ~~3. No Retry Logic for Transient Failures~~ Won't Fix

**Original Recommendation:** Add configurable retry with exponential backoff for install/upgrade operations.

**Decision:** Won't fix. If a package manager fails an install, the user should know immediately. That's normal behavior for a package manager. The user is responsible for retrying—this matches user expectations for CLI tools.

---

### ~~4. Lock File Lacks File Locking~~ Won't Fix

**Original Recommendation:** Use `flock` or a `.lock` file to prevent concurrent modifications.

**Decision:** Won't fix. The lock file stores information about packages the user has installed. It is incredibly unlikely that a user would run `plonk install` in multiple windows simultaneously. The tool's usage patterns make this edge case not worth the added complexity.

---

## UX Refinements

### ~~1. Confusing "Untracked" Semantics~~ Won't Fix

**Original Recommendation:** Consider renaming to "external" for packages or adding clarifying text.

**Decision:** Won't fix. "Untracked" is clear and consistent—files or packages that plonk doesn't manage are untracked. The terminology works.

---

### ~~2. Deprecated Function Still Exported~~ ✅ RESOLVED

**Status:** Fixed as of 2025-12-11

**Original Issue:** `internal/commands/helpers.go:24-30` had deprecated `ParsePackageSpec` function still exported.

**Resolution:** Removed as part of Category A dead code cleanup. The function was deleted entirely since `packages.ParsePackageSpec` is the correct replacement.

---

### ~~3. Duplicate Helper Functions~~ ✅ RESOLVED

**Status:** Fixed as of 2025-12-11

**Original Issue:** `internal/commands/helpers.go` had both exported `GetMetadataString` and unexported `getMetadataString`.

**Resolution:** Removed `GetMetadataString` (exported, unused) as part of Category A dead code cleanup. Kept `getMetadataString` (unexported) which is actively used by `add.go`.

---

### ~~4. Extensive Dead Code Identified~~ ✅ RESOLVED

**Status:** Fixed as of 2025-12-11

**Source:** `go run golang.org/x/tools/cmd/deadcode@latest ./...` (also available via `just find-dead-code`)

A comprehensive deadcode analysis identified **45+ unreachable functions** in production code. All have been addressed.

#### ~~Category A: Truly Dead~~ ✅ REMOVED

All Category A functions were removed across 9 commits (~440 lines deleted):

| File                                        | Functions Removed                                                                                         |
| ------------------------------------------- | --------------------------------------------------------------------------------------------------------- |
| `internal/commands/helpers.go`              | `ParsePackageSpec`, `IsValidManager`, `GetValidManagers`, `GetMetadataString`                             |
| `internal/commands/status.go`               | `sortItems`, `sortItemsByManager`                                                                         |
| `internal/output/colors.go`                 | `Available`, `Deployed`, `Managed`, `Valid`, `Invalid`, `Missing`, `NotAvailable`, `Drifted`, `Unmanaged` |
| `internal/output/dotfile_list_formatter.go` | Entire file deleted                                                                                       |
| `internal/output/progress.go`               | `ProgressUpdate`                                                                                          |
| `internal/output/spinner.go`                | `Spinner.UpdateText`, `WithSpinner`, `WithSpinnerResult`                                                  |
| `internal/output/utils.go`                  | `TruncateString`, `FormatValidationError`, `FormatNotFoundError`                                          |
| `internal/resources/types.go`               | `Result.Count`, `Result.IsEmpty`, `Result.AddToSummary`, `CreateDomainSummary`                            |
| `internal/resources/dotfiles/manager.go`    | `Manager.computeFileHash`, `Manager.createCompareFunc`                                                    |

#### ~~Category B: Test-Only Wrappers~~ ✅ MOVED TO TEST FILES

All Category B wrappers were moved to `export_test.go` files:

| Original Location                    | Function                      | New Location                  |
| ------------------------------------ | ----------------------------- | ----------------------------- |
| `diagnostics/health.go`              | `RunHealthChecks`             | `diagnostics/export_test.go`  |
| `orchestrator/reconcile.go`          | `ReconcileAll`                | `orchestrator/export_test.go` |
| `packages/helpers.go`                | `ExecuteCommand`              | `packages/executor_test.go`   |
| `packages/registry.go`               | `EnableV2`                    | Removed (tests set field)     |
| `packages/validation.go`             | `ValidateSpec`                | `packages/validation_test.go` |
| `dotfiles/config_handler.go`         | `NewConfigHandler`            | `dotfiles/export_test.go`     |
| `dotfiles/fileops.go`                | `NewFileOperationsWithWriter` | `dotfiles/export_test.go`     |
| `dotfiles/manager.go`                | `NewManager`                  | `dotfiles/export_test.go`     |
| `dotfiles/reconcile.go`              | `Reconcile`                   | Kept (cross-package dep)      |

#### Category C: Test Infrastructure (expected, kept)

| File                                             | Notes                                                             |
| ------------------------------------------------ | ----------------------------------------------------------------- |
| `internal/testutil/*.go`                         | All functions - test helpers by design                            |
| `internal/output/writer.go:35`                   | `SetWriter` - test injection point                                |
| `internal/resources/packages/executor.go:46-112` | `SetDefaultExecutor`, `MockCommandExecutor` - test infrastructure |

---

### ~~5. Doctor Command Could Show More Context~~ ✅ RESOLVED

**Status:** Fixed as of 2025-12-11

**Original Issue:** The `InstallHint` field existed in manager config but wasn't surfaced in doctor output.

**Resolution:** `internal/diagnostics/health.go:388-406` now displays `InstallHint` and `HelpURL` in suggestions when a package manager is missing.

---

## Maintainability Issues

### 1. Type Conversion Ceremony

**File:** `internal/commands/doctor.go:83-96`

```go
func convertHealthChecks(checks []diagnostics.HealthCheck) []output.HealthCheck {
    converted := make([]output.HealthCheck, len(checks))
    for i, check := range checks {
        converted[i] = output.HealthCheck{...}  // Field-by-field copy
    }
    return converted
}
```

This pattern repeats across commands. Types like `diagnostics.HealthCheck` and `output.HealthCheck` are structurally identical.

**Recommendation:** Either embed a shared type or use type aliases to reduce boilerplate.

**Priority:** Medium (reduces maintenance burden)

---

### 2. Registry Created Multiple Times

**Files:** Multiple locations throughout codebase

`packages.NewManagerRegistry()` is called in many places, recreating the registry each time:

- `internal/commands/helpers.go:34,46`
- `internal/commands/install.go:63`
- `internal/commands/upgrade.go:273`
- `internal/resources/packages/spec.go:55`
- `internal/resources/packages/operations.go:33,70,268`
- `internal/diagnostics/health.go:361`
- `internal/clone/setup.go:279`

While not expensive, it's unnecessary repetition.

**Recommendation:** Make the registry a singleton or pass it through context/dependency injection.

**Priority:** Low

**Guidance:** This is a definite code smell, and it _could_ cause unexpected behavior in future if plonk ever introduced a long lived TUI (as an example), but it doesn't cause harm or expense in the current CLI context.

---

### ~~3. Mock Executor Could Be Centralized~~ ✅ RESOLVED

**Status:** Fixed as of 2025-12-11

**Original Issue:** `MockCommandExecutor` was defined in individual test files.

**Resolution:** `MockCommandExecutor` is now centralized in `internal/resources/packages/executor.go:50-112`, alongside the `CommandExecutor` interface and `RealCommandExecutor`.

---

## Security Considerations

### ~~1. Package Name Validation~~ Won't Fix

**Original Recommendation:** Add explicit package name validation for defense in depth.

**Current Mitigation:** Commands are executed via `exec.Command`, not through a shell, so shell injection is not possible. This is safe as-is.

**Decision:** Won't fix. This is a dotfile and package management tool for experienced users. The `exec.Command` usage already prevents injection.

---

### 2. Path Traversal in Dotfiles

The dotfile system uses `filepath.Join` which normalizes `../` sequences correctly. No issues found.

---

## Minor Issues

| Location           | Issue                                                                             | Status                                      | Priority |
| ------------------ | --------------------------------------------------------------------------------- | ------------------------------------------- | -------- |
| ~~`main.go:39`~~   | ~~`setting.Value[:7]` relies on length check at line 38, but pattern is fragile~~ | ✅ Fixed - proper length check now in place | ~~Low~~  |
| `generic.go:74-82` | Duplicate idempotent check logic—could extract to helper                          | Open                                        | Low      |

---

## Recommendations Summary

### ~~High Priority~~ ✅ ALL COMPLETED

1. ~~**Remove deprecated ParsePackageSpec**~~ ✅ Removed in Category A cleanup
2. ~~**Remove duplicate getMetadataString**~~ ✅ Removed in Category A cleanup
3. ~~**Remove extensive dead code (Category A)**~~ ✅ ~440 lines removed across 9 commits
4. ~~**Clean up test-only wrappers (Category B)**~~ ✅ Moved to `export_test.go` files

### Medium Priority

1. ~~**Fix selective apply** - Either implement or remove `[files...]` argument~~ ✅ Resolved
2. **Cache ListInstalled results** - Improve performance for batch operations
3. **Reduce type conversion boilerplate** - Share types between packages

### Low Priority

1. **Registry singleton/DI** - Code smell, but no current harm
2. **Extract idempotent check helper** - Minor deduplication in generic.go

### Won't Fix

1. ~~Retry logic for transient failures~~ - User responsibility, matches CLI expectations
2. ~~File locking for concurrent access~~ - Usage patterns make this unnecessary
3. ~~"Untracked" terminology~~ - Terminology is clear and consistent
4. ~~Package name character validation~~ - Already safe via exec.Command
5. ~~Centralize mock executor~~ ✅ Resolved

---

## Summary Grades

| Category            | Grade | Notes                                                                              |
| ------------------- | ----- | ---------------------------------------------------------------------------------- |
| **Functionality**   | A-    | Core features work well; selective apply implemented; caching gap remains          |
| **UX**              | A     | Thoughtful output formatting; clear terminology                                    |
| **Maintainability** | A-    | Clean structure; dead code removed; minor boilerplate remains                      |
| **Security**        | A     | Safe by default; exec.Command prevents injection                                   |
| **Testing**         | A     | Comprehensive coverage; test-only wrappers properly isolated in `export_test.go`   |
| **Documentation**   | A     | Excellent README and docs/ structure                                               |

---

## Conclusion

Plonk is a mature, well-thought-out tool. The configuration-driven manager approach is genuinely innovative and differentiates it from alternatives like chezmoi and dotter. With the refinements identified above—particularly around performance caching and dead code cleanup—it could become an excellent choice for developers who want unified package + dotfile management.

The codebase demonstrates strong engineering practices: clean architecture, comprehensive testing, and thoughtful UX. The remaining issues are minor refinements rather than fundamental problems.

---

## Change Log

| Date       | Changes                                                                                                                                                                                                                                            |
| ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2025-12-09 | Initial review                                                                                                                                                                                                                                     |
| 2025-12-11 | Updated to reflect fixes: selective apply implemented, main.go length check fixed, InstallHint now surfaced in doctor, MockCommandExecutor centralized. Added maintainer guidance on Won't Fix items. Reorganized recommendations. Updated grades. |
| 2025-12-11 | Added comprehensive dead code analysis via `deadcode` tool. Identified ~40 unreachable functions categorized as: truly dead (Category A), test-only wrappers (Category B), and expected test infrastructure (Category C). Added to High Priority.  |
| 2025-12-11 | Accuracy review: Fixed line number references (getMetadataString:189, status.go:209-231, spec.go:55). Added missing dead code (`TruncateString`, `Manager.computeFileHash`, `Manager.createCompareFunc`). Expanded registry creation locations.    |
| 2025-12-11 | **Category A cleanup complete**: Removed ~440 lines of dead code across 9 commits. Deleted deprecated functions, unused formatters, and internal helpers. Updated Maintainability grade from B+ to A-.                                             |
| 2025-12-11 | **Category B cleanup complete**: Moved test-only wrappers to `export_test.go` files. Created test helper files in dotfiles/, diagnostics/, and orchestrator/ packages. All High Priority items now resolved.                                        |
