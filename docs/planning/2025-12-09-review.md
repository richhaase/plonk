# Plonk Code Review

**Date:** 2025-12-09
**Reviewer:** External Code Review
**Last Updated:** 2025-12-11
**Scope:** Full codebase review focusing on functionality, UX, maintainability, and suggested refinements

---

## Executive Summary

Plonk is a well-designed, thoughtfully-architected CLI tool for unified package and dotfile management. The configuration-driven package manager approach is elegant, the codebase follows Go best practices, and there's clear attention to UX. This review identifies areas for refinement to take the tool from good to great.

**Overall Assessment:** Strong foundation with room for polish.

---

## Strengths

| Area                  | Observation                                                                              |
| --------------------- | ---------------------------------------------------------------------------------------- |
| **Architecture**      | Clean separation: commands → orchestrator → resources → config. Easy to reason about.    |
| **Extensibility**     | YAML-driven package managers is brilliant—users can add managers without recompiling.    |
| **Testing**           | 90+ test files with table-driven tests, mocks, golden files, and BATS integration tests. |
| **UX Polish**         | Spinners, color support, `NO_COLOR` respect, multiple output formats (table/json/yaml).  |
| **Idempotency**       | Pattern-based idempotent error handling ensures safe re-runs.                            |
| **Atomic Operations** | Lock file and dotfile writes use atomic file operations—good data safety.                |

---

## Functionality Issues

### ~~1. Selective Apply Not Implemented~~ ✅ RESOLVED

**Status:** Fixed as of 2025-12-11

**Original Issue:** `internal/commands/apply.go:174-177` had a TODO indicating selective apply was not implemented.

**Resolution:** `runSelectiveApply()` function now exists at lines 152-220, properly filtering specific dotfiles when paths are provided as arguments.

---

### 2. IsInstalled Is O(n) Per Check

**File:** `internal/resources/packages/generic.go:145-158`

```go
func (g *GenericManager) IsInstalled(ctx context.Context, name string) (bool, error) {
    installed, err := g.ListInstalled(ctx)  // Calls package manager every time
    // ... linear search
}
```

**Impact:** Checking 10 packages means 10 subprocess invocations. Slow for large package lists.

**Recommendation:** Cache `ListInstalled` results with a short TTL or build a `map[string]bool` once per session.

**Priority:** Medium

---

### ~~3. No Retry Logic for Transient Failures~~ Won't Fix

**Original Recommendation:** Add configurable retry with exponential backoff for install/upgrade operations.

**Decision:** Won't fix. If a package manager fails an install, the user should know immediately. That's normal behavior for a package manager. The user is responsible for retrying—this matches user expectations for CLI tools.

---

### ~~4. Lock File Lacks File Locking~~ Won't Fix

**Original Recommendation:** Use `flock` or a `.lock` file to prevent concurrent modifications.

**Decision:** Won't fix. The lock file stores information about packages the user has installed. It is incredibly unlikely that a user would run `plonk install` in multiple windows simultaneously. The tool's usage patterns make this edge case not worth the added complexity.

---

## UX Refinements

### ~~1. Confusing "Untracked" Semantics~~ Won't Fix

**Original Recommendation:** Consider renaming to "external" for packages or adding clarifying text.

**Decision:** Won't fix. "Untracked" is clear and consistent—files or packages that plonk doesn't manage are untracked. The terminology works.

---

### 2. Deprecated Function Still Exported

**File:** `internal/commands/helpers.go:24-30`

```go
// Deprecated: Use packages.ParsePackageSpec instead...
func ParsePackageSpec(spec string) (manager, packageName string) {
```

Exported deprecated functions clutter the API and may confuse contributors.

**Recommendation:** Remove or unexport since there's a better replacement in `packages.ParsePackageSpec`.

**Priority:** High

**Guidance:** Deprecated functions should be removed and migrations to current functions should be completed if necessary. Plonk is not a library, it's a CLI, so keeping deprecated functions is really just keeping dead code.

---

### 3. Duplicate Helper Functions

**File:** `internal/commands/helpers.go`

```go
func GetMetadataString(...)  // Line 141 - exported
func getMetadataString(...)  // Line 190 - unexported duplicate
```

**Recommendation:** Remove the unexported duplicate.

**Priority:** High

**Guidance:** See previous guidance regarding dead code.

---

### ~~4. Doctor Command Could Show More Context~~ ✅ RESOLVED

**Status:** Fixed as of 2025-12-11

**Original Issue:** The `InstallHint` field existed in manager config but wasn't surfaced in doctor output.

**Resolution:** `internal/diagnostics/health.go:388-406` now displays `InstallHint` and `HelpURL` in suggestions when a package manager is missing.

---

## Maintainability Issues

### 1. Type Conversion Ceremony

**File:** `internal/commands/doctor.go:83-96`

```go
func convertHealthChecks(checks []diagnostics.HealthCheck) []output.HealthCheck {
    converted := make([]output.HealthCheck, len(checks))
    for i, check := range checks {
        converted[i] = output.HealthCheck{...}  // Field-by-field copy
    }
    return converted
}
```

This pattern repeats across commands. Types like `diagnostics.HealthCheck` and `output.HealthCheck` are structurally identical.

**Recommendation:** Either embed a shared type or use type aliases to reduce boilerplate.

**Priority:** Medium (reduces maintenance burden)

---

### 2. Registry Created Multiple Times

**Files:** `helpers.go:34`, `spec.go:56`, and others

`packages.NewManagerRegistry()` is called in many places, recreating the registry each time. While not expensive, it's unnecessary repetition.

**Recommendation:** Make the registry a singleton or pass it through context/dependency injection.

**Priority:** Low

**Guidance:** This is a definite code smell, and it _could_ cause unexpected behavior in future if plonk ever introduced a long lived TUI (as an example), but it doesn't cause harm or expense in the current CLI context.

---

### ~~3. Mock Executor Could Be Centralized~~ ✅ RESOLVED

**Status:** Fixed as of 2025-12-11

**Original Issue:** `MockCommandExecutor` was defined in individual test files.

**Resolution:** `MockCommandExecutor` is now centralized in `internal/resources/packages/executor.go:50-112`, alongside the `CommandExecutor` interface and `RealCommandExecutor`.

---

## Security Considerations

### ~~1. Package Name Validation~~ Won't Fix

**Original Recommendation:** Add explicit package name validation for defense in depth.

**Current Mitigation:** Commands are executed via `exec.Command`, not through a shell, so shell injection is not possible. This is safe as-is.

**Decision:** Won't fix. This is a dotfile and package management tool for experienced users. The `exec.Command` usage already prevents injection.

---

### 2. Path Traversal in Dotfiles

The dotfile system uses `filepath.Join` which normalizes `../` sequences correctly. No issues found.

---

## Minor Issues

| Location           | Issue                                                                             | Status                                      | Priority |
| ------------------ | --------------------------------------------------------------------------------- | ------------------------------------------- | -------- |
| ~~`main.go:39`~~   | ~~`setting.Value[:7]` relies on length check at line 38, but pattern is fragile~~ | ✅ Fixed - proper length check now in place | ~~Low~~  |
| `generic.go:74-82` | Duplicate idempotent check logic—could extract to helper                          | Open                                        | Low      |

---

## Recommendations Summary

### High Priority

1. **Remove deprecated ParsePackageSpec** - Dead code in a CLI should be removed
2. **Remove duplicate getMetadataString** - Dead code cleanup

### Medium Priority

1. ~~**Fix selective apply** - Either implement or remove `[files...]` argument~~ ✅ Resolved
2. **Cache ListInstalled results** - Improve performance for batch operations
3. **Reduce type conversion boilerplate** - Share types between packages

### Low Priority

1. **Registry singleton/DI** - Code smell, but no current harm
2. **Extract idempotent check helper** - Minor deduplication in generic.go

### Won't Fix

1. ~~Retry logic for transient failures~~ - User responsibility, matches CLI expectations
2. ~~File locking for concurrent access~~ - Usage patterns make this unnecessary
3. ~~"Untracked" terminology~~ - Terminology is clear and consistent
4. ~~Package name character validation~~ - Already safe via exec.Command
5. ~~Centralize mock executor~~ ✅ Resolved

---

## Summary Grades

| Category            | Grade | Notes                                                                         |
| ------------------- | ----- | ----------------------------------------------------------------------------- |
| **Functionality**   | A-    | Core features work well; selective apply now implemented; caching gap remains |
| **UX**              | A     | Thoughtful output formatting; clear terminology                               |
| **Maintainability** | B+    | Good structure; some boilerplate and duplication                              |
| **Security**        | A     | Safe by default; exec.Command prevents injection                              |
| **Testing**         | A     | Comprehensive coverage; good testing patterns                                 |
| **Documentation**   | A     | Excellent README and docs/ structure                                          |

---

## Conclusion

Plonk is a mature, well-thought-out tool. The configuration-driven manager approach is genuinely innovative and differentiates it from alternatives like chezmoi and dotter. With the refinements identified above—particularly around performance caching and dead code cleanup—it could become an excellent choice for developers who want unified package + dotfile management.

The codebase demonstrates strong engineering practices: clean architecture, comprehensive testing, and thoughtful UX. The remaining issues are minor refinements rather than fundamental problems.

---

## Change Log

| Date       | Changes                                                                                                                                                                             |
| ---------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 2025-12-09 | Initial review                                                                                                                                                                      |
| 2025-12-11 | Updated to reflect fixes: selective apply implemented, main.go length check fixed, InstallHint now surfaced in doctor, MockCommandExecutor centralized. Added maintainer guidance on Won't Fix items. Reorganized recommendations. Updated grades. |
