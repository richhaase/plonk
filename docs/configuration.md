# Plonk Configuration

This is the comprehensive guide to configuring plonk. Plonk uses two configuration files located in `~/.config/plonk/`:

## Table of Contents

- [Lock File (plonk.lock)](#lock-file-plonklock)
- [Filesystem as State](#filesystem-as-state)
- [Configuration File (plonk.yaml)](#configuration-file-plonkyaml)
- [Basic Configuration](#basic-configuration)
- [Dotfile Configuration](#dotfile-configuration)
- [Hook Configuration](#hook-configuration)
- [Timeout Configuration](#timeout-configuration)
- [Advanced Configuration](#advanced-configuration)
- [Environment Variables](#environment-variables)
- [Configuration Precedence](#configuration-precedence)
- [Common Configuration Scenarios](#common-configuration-scenarios)

## Lock File (plonk.lock)

The lock file is automatically maintained by plonk and tracks your managed resources. Do not edit this file manually.

**Format:**
```yaml
version: 2
packages:
  brew:
    - name: ripgrep
      version: 14.0.3
      installed_at: 2025-07-27T11:01:03.519704-06:00
    - name: fd
      version: 8.7.0
      installed_at: 2025-07-27T11:00:51.028708-06:00
  npm:
    - name: prettier
      version: 3.1.0
      installed_at: 2025-07-28T15:11:08.74692-06:00
```

**Note:** Dotfiles are not tracked in the lock file. Instead, the filesystem structure of `$PLONK_DIR` itself represents the dotfile state (see [Filesystem as State](#filesystem-as-state)).

## Filesystem as State

Plonk uses the filesystem structure of `$PLONK_DIR` to represent dotfile state. The contents of this directory define what dotfiles are managed:

```
$PLONK_DIR/
├── plonk.yaml        # Configuration (not a dotfile)
├── plonk.lock        # Package state (not a dotfile)
├── zshrc             # Deployed to ~/.zshrc
├── gitconfig         # Deployed to ~/.gitconfig
└── config/
    └── nvim/
        └── init.lua  # Deployed to ~/.config/nvim/init.lua
```

This approach provides several benefits:
- No separate tracking file needed for dotfiles
- Easy to see what's managed by examining the directory
- Git-native workflow (the directory is your repository)
- Impossible for tracking and filesystem to get out of sync

**Always Excluded**:
- `plonk.yaml` and `plonk.lock` - Configuration and package state files
- `.plonk/` directory - Reserved for future plonk metadata (hooks, templates, etc.)

## Configuration File (plonk.yaml)

User configuration file for customizing plonk behavior. This file is optional - plonk works with sensible defaults.

## Basic Configuration

### Package Manager Settings

```yaml
# Default package manager when no prefix is specified
default_manager: brew    # Options: brew, npm, cargo, pip, gem, go

# Alternative examples:
# default_manager: npm    # Use npm for global JavaScript tools
# default_manager: cargo  # Use cargo for Rust-based CLI tools
```

## Dotfile Configuration

### Ignore Patterns

Control which files are excluded when scanning for dotfiles:

```yaml
dotfiles:
  ignore_patterns:
    # Temporary files
    - "*.swp"
    - "*.tmp"
    - "*.bak"
    - "*~"

    # OS-specific files
    - ".DS_Store"        # macOS
    - "Thumbs.db"        # Windows
    - ".Trash"

    # Cache and build directories
    - ".cache/*"
    - "node_modules/*"
    - "target/*"         # Rust build output
    - "__pycache__/*"    # Python cache

    # Version control
    - ".git/*"
    - ".svn/*"

    # IDE/Editor files
    - ".vscode/*"
    - ".idea/*"
    - "*.log"
```

### Directory Expansion

Specify directories to recursively scan for dotfiles:

```yaml
dotfiles:
  expand_directories:
    - "~/.config"        # Standard config location
    - "~/.local/share"   # User data files
    - "~/.ssh"           # SSH configuration
    # Add custom directories as needed
```

## Hook Configuration

### Pre and Post Apply Hooks

Execute commands before and after apply operations:

```yaml
hooks:
  # Commands run before apply starts
  pre_apply:
    - "echo 'Starting plonk apply...'"
    - "brew update"      # Update Homebrew before installing
    - "git pull"         # Pull latest dotfiles changes

  # Commands run after apply completes
  post_apply:
    - "echo 'Apply completed successfully'"
    - "source ~/.zshrc"  # Reload shell configuration
    - "tmux source-file ~/.tmux.conf"  # Reload tmux config
```

### Hook Timeout and Error Handling

```yaml
hooks:
  # Hook-specific settings
  timeout: 600          # 10 minutes timeout for hooks
  continue_on_error: true  # Don't fail apply if hooks fail

  pre_apply:
    - "brew doctor"     # Check Homebrew health
  post_apply:
    - "plonk doctor"    # Verify system after apply
```

## Timeout Configuration

### Operation Timeouts

Control how long operations wait before timing out:

```yaml
# All timeouts in seconds
package_timeout: 300      # Package install/uninstall (5 minutes)
operation_timeout: 60     # Search operations (1 minute)
dotfile_timeout: 30       # Dotfile operations (30 seconds)

# Examples for different scenarios:
# Fast network, powerful machine:
# package_timeout: 180    # 3 minutes
# operation_timeout: 30   # 30 seconds

# Slow network, limited resources:
# package_timeout: 600    # 10 minutes
# operation_timeout: 120  # 2 minutes
```

## Diff Tool Configuration

### Custom Diff Tool

Configure which tool is used to display differences for drifted dotfiles:

```yaml
# Default: git diff --no-index (zero-config)
diff_tool: "delta"

# Other examples:
# diff_tool: "vimdiff"              # Vim's diff mode
# diff_tool: "code --diff --wait"   # VS Code diff
# diff_tool: "meld"                 # GUI diff tool
# diff_tool: "colordiff"            # Colorized diff
```

The diff tool is executed as: `{tool} {source_path} {deployed_path}`

## Advanced Configuration

### Complete Real-World Example

A comprehensive configuration for a development environment:

```yaml
# Package management
default_manager: brew

# Dotfile management
dotfiles:
  ignore_patterns:
    - "*.swp"
    - "*.tmp"
    - ".DS_Store"
    - ".cache/*"
    - "node_modules/*"
    - ".git/*"
  expand_directories:
    - "~/.config"
    - "~/.local/share"

# Hooks for automated maintenance
hooks:
  timeout: 300
  continue_on_error: true
  pre_apply:
    - "echo 'Updating package managers...'"
    - "brew update"
    - "npm update -g"
  post_apply:
    - "echo 'Sourcing shell configuration...'"
    - "source ~/.zshrc || true"
    - "echo 'Apply completed successfully'"

# Conservative timeouts for reliability
package_timeout: 600      # 10 minutes for large packages
operation_timeout: 90     # 90 seconds for searches
dotfile_timeout: 60       # 1 minute for file operations

# Diff tool for viewing drift
diff_tool: "delta"        # Use delta for syntax-highlighted diffs
```

## Environment Variables

- `PLONK_DIR` - Override config directory location (default: `~/.config/plonk`)
- `VISUAL` - Primary editor for `plonk config edit` command
- `EDITOR` - Fallback editor if VISUAL not set
- `NO_COLOR` - Disable colored output when set to any value

## Configuration Precedence

Settings are applied in the following order (highest to lowest priority):

1. **Command-line flags** - Direct flags like `--dry-run`, `--packages`
2. **Environment variables** - `PLONK_DIR`, `EDITOR`, etc.
3. **Configuration file** - Settings in `plonk.yaml`
4. **Built-in defaults** - Plonk's default values

Example: If you set `default_manager: npm` in plonk.yaml but run `plonk install brew:wget`, the `brew:` prefix overrides the configuration.

## Common Configuration Scenarios

### Scenario 1: NPM-Focused Development
For JavaScript/Node.js heavy workflows:
```yaml
default_manager: npm
package_timeout: 180     # NPM can be faster than Homebrew
operation_timeout: 45
```

### Scenario 2: Minimal Dotfile Management
For users who only want basic dotfile tracking:
```yaml
dotfiles:
  ignore_patterns:
    - "*"                # Ignore everything by default
  # Manually add only specific files with `plonk add`
```

### Scenario 3: Automated CI/CD Integration
For automated environments:
```yaml
hooks:
  continue_on_error: false  # Fail on hook errors
  timeout: 60
  pre_apply:
    - "git status --porcelain | wc -l | grep -q '^0$'"  # Ensure clean repo
  post_apply:
    - "plonk doctor"      # Verify system health
```

### Scenario 4: Multi-Language Development
For polyglot developers:
```yaml
default_manager: brew     # System tools via Homebrew
dotfiles:
  expand_directories:
    - "~/.config"
    - "~/.local/share"
    - "~/.cargo"          # Rust configuration
    - "~/.npm"            # NPM configuration
hooks:
  pre_apply:
    - "brew update"
    - "rustup update"     # Keep Rust toolchain updated
```

## Creating and Managing Configuration

```bash
# View current configuration (including defaults)
plonk config show

# Create and edit configuration file
plonk config edit

# View configuration with different output formats
plonk config show --output yaml
plonk config show --output json
```

## Viewing Configuration

The `plonk config show` command displays your effective configuration with user-defined values highlighted:

```bash
# Show configuration with (user-defined) annotations in blue
plonk config show

# Output in JSON format (clean, no annotations)
plonk config show -o json
```

This makes it easy to see at a glance which settings you've customized versus which are using defaults.

## Configuration Editing

The `plonk config edit` command provides a visudo-style editing experience:

1. **Full Runtime View**: Shows all available configuration options with their current values (defaults + your overrides)
2. **User-Defined Annotations**: Values you've customized are marked with `# (user-defined)` comments
3. **Validation Loop**: If you save invalid configuration, you'll get options to:
   - (e)dit again to fix errors
   - (r)evert changes and exit
   - (q)uit without saving
4. **Minimal Saving**: Only values that differ from defaults are written to `plonk.yaml`

This approach keeps your configuration file clean and makes it immediately clear what you've customized.

### Example Edit Session

When you run `plonk config edit`, you'll see something like:

```yaml
# Plonk Configuration Editor
# - Delete any line to revert to default
# - Only values different from defaults will be saved to plonk.yaml
# - Save and exit to apply, or exit without saving to cancel

default_manager: brew
operation_timeout: 300
package_timeout: 600  # (user-defined)
dotfile_timeout: 60

expand_directories:
  - .config
  - .local
  - .ssh  # (user-defined)
```

In this example, only `package_timeout` and the `expand_directories` list would be saved to plonk.yaml.
